console.log("Background service worker loaded");chrome.runtime.onInstalled.addListener(e=>{console.log("Extension installed:",e.reason),chrome.storage.sync.set({extensionEnabled:!0,theme:"light"})});chrome.tabs.onUpdated.addListener((e,t,o)=>{t.status==="complete"&&o.url&&(console.log("Tab updated:",o.url),chrome.tabs.sendMessage(e,{type:"PAGE_LOADED",url:o.url}).catch(()=>{}))});chrome.runtime.onMessage.addListener((e,t,o)=>{switch(console.log("Background received message:",e),e.type){case"GET_TAB_INFO":t.tab&&o({tabId:t.tab.id,url:t.tab.url,title:t.tab.title});break;case"TOGGLE_EXTENSION":return chrome.storage.sync.get(["extensionEnabled"],r=>{const c=!r.extensionEnabled;chrome.storage.sync.set({extensionEnabled:c}),chrome.tabs.query({},s=>{s.forEach(a=>{a.id&&chrome.tabs.sendMessage(a.id,{type:"EXTENSION_TOGGLED",enabled:c}).catch(()=>{})})}),o({enabled:c})}),!0;case"OAUTH_SUCCESS":return console.log("OAuth success, code received"),chrome.storage.local.set({oauth_pending:{code:e.code,state:e.state,timestamp:Date.now()}}).then(()=>{console.log("OAuth data stored, waiting for sidepanel to process"),o({success:!0})}).catch(r=>{console.error("Failed to store OAuth data:",r),o({success:!1,error:r.message})}),!0;case"OAUTH_ERROR":console.error("OAuth error:",e.error,e.errorDescription),o({success:!1,error:e.error});break;case"SIGNOUT_SUCCESS":console.log("User signed out successfully"),o({success:!0});break;default:console.log("Unknown message type:",e.type)}});chrome.action.onClicked.addListener(e=>{e.id&&chrome.sidePanel.open({tabId:e.id})});chrome.storage.onChanged.addListener((e,t)=>{console.log("Storage changed:",e,t),chrome.tabs.query({},o=>{o.forEach(r=>{r.id&&chrome.tabs.sendMessage(r.id,{type:"STORAGE_CHANGED",changes:e}).catch(()=>{})})})});
