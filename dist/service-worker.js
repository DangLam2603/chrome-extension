console.log("Background service worker loaded");chrome.runtime.onInstalled.addListener(e=>{console.log("Extension installed:",e.reason),chrome.storage.sync.set({extensionEnabled:!0,theme:"light"}),chrome.storage.local.get(["isAuthenticated"],t=>{t.isAuthenticated||console.log("User not authenticated")})});chrome.tabs.onUpdated.addListener((e,t,o)=>{t.status==="complete"&&o.url&&(console.log("Tab updated:",o.url),chrome.tabs.sendMessage(e,{type:"PAGE_LOADED",url:o.url}).catch(()=>{}))});chrome.runtime.onMessage.addListener((e,t,o)=>{switch(console.log("Background received message:",e),e.type){case"GET_TAB_INFO":t.tab&&o({tabId:t.tab.id,url:t.tab.url,title:t.tab.title});break;case"TOGGLE_EXTENSION":return chrome.storage.sync.get(["extensionEnabled"],a=>{const r=!a.extensionEnabled;chrome.storage.sync.set({extensionEnabled:r}),chrome.tabs.query({},n=>{n.forEach(c=>{c.id&&chrome.tabs.sendMessage(c.id,{type:"EXTENSION_TOGGLED",enabled:r}).catch(()=>{})})}),o({enabled:r})}),!0;case"CHECK_AUTH":return chrome.storage.local.get(["isAuthenticated"],a=>{o({isAuthenticated:a.isAuthenticated||!1})}),!0;case"SIGN_OUT":return chrome.storage.local.remove(["authTokens","isAuthenticated","codeVerifier"],()=>{o({success:!0})}),!0;default:console.log("Unknown message type:",e.type)}});chrome.action.onClicked.addListener(e=>{e.id&&chrome.sidePanel.open({tabId:e.id})});chrome.storage.onChanged.addListener((e,t)=>{console.log("Storage changed:",e,t),chrome.tabs.query({},o=>{o.forEach(a=>{a.id&&chrome.tabs.sendMessage(a.id,{type:"STORAGE_CHANGED",changes:e}).catch(()=>{})})})});
